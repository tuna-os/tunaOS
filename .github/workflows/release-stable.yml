name: Release Stable

on:
  push:
    tags:
      - '*-[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9].[0-9]*'
      - '!*-test' # Exclude test tags

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  parse_tag:
    runs-on: ubuntu-latest
    outputs:
      variant: ${{ steps.parse.outputs.variant }}
      flavor: ${{ steps.parse.outputs.flavor }}
      version: ${{ steps.parse.outputs.version }}
    steps:
      - name: Parse tag
        id: parse
        run: |
          TAG="${{ github.ref_name }}"
          # Expected format: <variant>-YYYYMMDD.x or <variant>-<flavor>-YYYYMMDD.x
          if [[ "$TAG" =~ ^([a-z]+)-(dx|gdx)-([0-9]{8}\.[0-9]+)$ ]]; then
            echo "variant=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "flavor=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          elif [[ "$TAG" =~ ^([a-z]+)-([0-9]{8}\.[0-9]+)$ ]]; then
            echo "variant=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "flavor=base" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
          else
            echo "Invalid tag format: $TAG"
            exit 1
          fi

  release-stable:
    needs: parse_tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image name
        id: image
        run: |
          VARIANT="${{ needs.parse_tag.outputs.variant }}"
          FLAVOR="${{ needs.parse_tag.outputs.flavor }}"
          if [ "$FLAVOR" != "base" ]; then
            IMAGE_NAME="${VARIANT}-${FLAVOR}"
          else
            IMAGE_NAME="${VARIANT}"
          fi
          echo "name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Pull Testing Image
        run: podman pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ steps.image.outputs.name }}:testing

      # In a real scenario, we might need to re-generate the QCOW2 or pull it from an artifact store if we want to test the EXACT bits.
      # For this pipeline, we'll regenerate it from the :testing image to ensure we are testing what we are promoting.
      - name: Generate Disk Image
        run: |
          mkdir -p output
          # Using privileged mode for bootc-image-builder
          sudo podman run --rm -it --privileged \
            -v $(pwd)/output:/output \
            -v $(pwd)/config.toml:/config.toml \
            -v /var/lib/containers/storage:/var/lib/containers/storage \
            quay.io/centos-bootc/bootc-image-builder:latest \
            build --type qcow2 \
            --config /config.toml \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ steps.image.outputs.name }}:testing

      - name: Upload Image to S3
        id: upload
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

            - name: Upload to S3
              run: |
                aws s3 cp output/qcow2/disk.qcow2 s3://${{ secrets.S3_BUCKET }}/tunaos-${{ github.ref_name }}.qcow2
                echo "IMAGE_URL=https://${{ secrets.S3_BUCKET }}.s3.amazonaws.com/tunaos-${{ github.ref_name }}.qcow2" >> $GITHUB_ENV

            - name: Promote to Stable
              if: success()
              run: |
                VERSION=${{ github.ref_name }}
                IMAGE_NAME="${{ steps.image.outputs.name }}"
                skopeo copy \
                  docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${IMAGE_NAME}:testing \
                  docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${IMAGE_NAME}:stable
                skopeo copy \
                  docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${IMAGE_NAME}:testing \
                  docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${IMAGE_NAME}:${VERSION}

      
