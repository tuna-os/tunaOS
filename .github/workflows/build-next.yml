name: Build Next Image
on:
  push:
    branches:
      - main
      - coreos
  workflow_dispatch:
    inputs:
      variant:
        description: 'Image variant to build (yellowfin, albacore, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - yellowfin
          - albacore
      flavor:
        description: 'Build flavor (base, dx, gdx, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - base
          - dx
          - gdx
      registry:
        description: 'Container registry to use'
        required: false
        default: 'ghcr.io'
        type: string
      platforms:
        description: 'Platforms to build (comma-separated)'
        required: false
        default: 'linux/arm64,linux/amd64,linux/amd64/v2'
        type: string

env:
  REGISTRY: ${{ inputs.registry || 'ghcr.io' }}
  IMAGE_NAMESPACE: ${{ github.repository_owner }}

jobs:
  generate_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate image variant matrix
        id: set-matrix
        env:
          INPUT_VARIANT: ${{ inputs.variant || 'all' }}
          INPUT_FLAVOR: ${{ inputs.flavor || 'all' }}
          INPUT_PLATFORMS: ${{ inputs.platforms || '' }}
        run: |
          # Define image variants to build based on input
          if [ "$INPUT_VARIANT" = "all" ]; then
            IMAGE_VARIANTS="yellowfin albacore"
          else
            IMAGE_VARIANTS="$INPUT_VARIANT"
          fi
          
          # Define flavors to build based on input, ensuring dependencies are met
          FLAVORS_TO_BUILD=""
          if [ "$INPUT_FLAVOR" = "all" ]; then
            FLAVORS_TO_BUILD="base dx gdx"
          elif [ "$INPUT_FLAVOR" = "gdx" ]; then
            FLAVORS_TO_BUILD="base dx gdx"
          elif [ "$INPUT_FLAVOR" = "dx" ]; then
            FLAVORS_TO_BUILD="base dx"
          else # base
            FLAVORS_TO_BUILD="base"
          fi
          
          # Generate matrix
          MATRIX="{\"include\":[]}"
          for variant in $IMAGE_VARIANTS; do
            for flavor in $FLAVORS_TO_BUILD; do
              # Determine image name based on flavor
              if [ "$flavor" != "base" ]; then
                IMAGE_NAME="${variant}-${flavor}"
              else
                IMAGE_NAME="${variant}"
              fi
              
              # Set variant-specific descriptions and platforms
              case "$variant" in
                yellowfin)
                  DESCRIPTION="ðŸ  Based on AlmaLinux Kitten 10"
                  PLATFORMS="linux/arm64,linux/amd64,linux/amd64/v2"
                  ;;
                albacore)
                  DESCRIPTION="ðŸŸ Based on AlmaLinux 10"
                  PLATFORMS="linux/arm64,linux/amd64,linux/amd64/v2"
                  ;;
              esac
              
              # Override platforms if provided via input
              if [ -n "$INPUT_PLATFORMS" ]; then
                PLATFORMS="$INPUT_PLATFORMS"
              fi
              
              # Add flavor suffix to description
              case "$flavor" in
                dx)
                  DESCRIPTION="${DESCRIPTION} DX"
                  ;;
                gdx)
                  DESCRIPTION="${DESCRIPTION} GDX"
                  ;;
              esac
              
              MATRIX="$(echo "${MATRIX}" | jq ".include += [{
                \"variant\": \"${variant}\",
                \"flavor\": \"${flavor}\",
                \"image_name\": \"${IMAGE_NAME}\",
                \"description\": \"${DESCRIPTION}\",
                \"platforms\": \"${PLATFORMS}\"
              }]")"
            done
          done
          
          echo "matrix=$(echo "${MATRIX}" | jq -c '.')" >> $GITHUB_OUTPUT

  build_base_images:
    needs: generate_matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}
    permissions:
      contents: read
      packages: write
      id-token: write
    if: matrix.flavor == 'base'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build base image
        uses: ./.github/workflows/reusable-build-image.yml
        secrets: inherit
        with:
          image-name: ${{ matrix.image_name }}
          image-desc: ${{ matrix.description }}
          image-variant: ${{ matrix.variant }}
          flavor: base
          platforms: ${{ matrix.platforms }}
          default-tag: next
          rechunk: true
          sbom: false
          publish: true

  build_dx_images:
    needs: [generate_matrix, build_base_images]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}
    permissions:
      contents: read
      packages: write
      id-token: write
    if: matrix.flavor == 'dx'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build DX image (chain from base)
        uses: ./.github/workflows/reusable-build-image.yml
        secrets: inherit
        with:
          image-name: ${{ matrix.image_name }}
          image-desc: ${{ matrix.description }}
          image-variant: ${{ matrix.variant }}
          flavor: dx
          platforms: ${{ matrix.platforms }}
          default-tag: next
          rechunk: true
          sbom: false
          publish: true

  build_gdx_images:
    needs: [generate_matrix, build_dx_images]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}
    permissions:
      contents: read
      packages: write
      id-token: write
    if: matrix.flavor == 'gdx'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build GDX image (chain from DX)
        uses: ./.github/workflows/reusable-build-image.yml
        secrets: inherit
        with:
          image-name: ${{ matrix.image_name }}
          image-desc: ${{ matrix.description }}
          image-variant: ${{ matrix.variant }}
          flavor: gdx
          platforms: ${{ matrix.platforms }}
          default-tag: next
          rechunk: true
          sbom: false
          publish: true
          remove-unwanted-software: true
